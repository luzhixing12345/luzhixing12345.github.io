

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="https://raw.githubusercontent.com/learner-lu/picbed/master/logo.png">
  <link rel="icon" href="https://raw.githubusercontent.com/learner-lu/picbed/master/logo.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#4a00e0">
  <meta name="author" content="luzhixing12345">
  <meta name="keywords" content="">
  
    <meta name="description" content="《深入理解计算机系统》Bomb Lab实验解析 CS:APP - Bomb Lab   基本知识  x86-64架构调用函数时参数传递使用的寄存器和栈地址    %rdi %rsi %rdx %rcx %r8 %r9 (%rsp) (%rsp+8) (%rsp+…)     return -&gt; %rax  x86-64寄存器   操作数指示符   常用汇编  mov S,D : 把S的值传">
<meta property="og:type" content="article">
<meta property="og:title" content="02-BombLab">
<meta property="og:url" content="https://luzhixing12345.github.io/2022/10/24/CSAPP/02-BombLab/index.html">
<meta property="og:site_name" content="kamilu的博客">
<meta property="og:description" content="《深入理解计算机系统》Bomb Lab实验解析 CS:APP - Bomb Lab   基本知识  x86-64架构调用函数时参数传递使用的寄存器和栈地址    %rdi %rsi %rdx %rcx %r8 %r9 (%rsp) (%rsp+8) (%rsp+…)     return -&gt; %rax  x86-64寄存器   操作数指示符   常用汇编  mov S,D : 把S的值传">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/learner-lu/picbed/master/QQ%E5%9B%BE%E7%89%8720221015171443.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/learner-lu/picbed/master/as123gsz.jpg">
<meta property="article:published_time" content="2022-10-23T17:46:00.000Z">
<meta property="article:modified_time" content="2022-11-03T17:31:24.911Z">
<meta property="article:author" content="luzhixing12345">
<meta property="article:tag" content="CSAPP">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://raw.githubusercontent.com/learner-lu/picbed/master/QQ%E5%9B%BE%E7%89%8720221015171443.jpg">
  
  
  <title>02-BombLab - kamilu的博客</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hint.css@2/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"luzhixing12345.github.io","root":"/","version":"1.8.14","typing":{"enable":false,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"fEy8W8VvIoc26nT53dV2157j-gzGzoHsz","app_key":"s9HXuqmvBWrOaAiLA07Jg59A","server_url":"https://fey8w8vv.lc-cn-n1-shared.com","path":"window.location.pathname","ignore_local":true}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 6.1.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Kamilu-blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('https://raw.githubusercontent.com/learner-lu/picbed/master/background.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="02-BombLab">
              
                02-BombLab
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2022-10-24 01:46" pubdate>
        2022年10月24日 凌晨
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      10k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      87 分钟
    </span>
  

  
  
    
      <!-- LeanCloud 统计文章PV -->
      <span id="leancloud-page-views-container" class="post-meta" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="leancloud-page-views"></span> 次
      </span>
    
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">02-BombLab</h1>
            
              <p class="note note-info">
                
                  本文最后更新于：5 天前
                
              </p>
            
            <div class="markdown-body">
              <blockquote>
<p><a target="_blank" rel="noopener" href="https://earthaa.github.io/2020/01/12/CSAPP-Bomblab/">《深入理解计算机系统》Bomb Lab实验解析</a></p>
<p><a target="_blank" rel="noopener" href="https://hakula.xyz/posts/note/csapp/bomb-lab/">CS:APP - Bomb Lab</a></p>
</blockquote>
<h2 id="基本知识"><a class="markdownIt-Anchor" href="#基本知识"></a> 基本知识</h2>
<h3 id="x86-64架构调用函数时参数传递使用的寄存器和栈地址"><a class="markdownIt-Anchor" href="#x86-64架构调用函数时参数传递使用的寄存器和栈地址"></a> x86-64架构调用函数时参数传递使用的寄存器和栈地址</h3>
<table>
<thead>
<tr>
<th style="text-align:center">%rdi</th>
<th style="text-align:center">%rsi</th>
<th style="text-align:center">%rdx</th>
<th style="text-align:center">%rcx</th>
<th style="text-align:center">%r8</th>
<th style="text-align:center">%r9</th>
<th style="text-align:center">(%rsp)</th>
<th style="text-align:center">(%rsp+8)</th>
<th style="text-align:center">(%rsp+…)</th>
</tr>
</thead>
<tbody></tbody>
</table>
<p>return -&gt; %rax</p>
<h3 id="x86-64寄存器"><a class="markdownIt-Anchor" href="#x86-64寄存器"></a> x86-64寄存器</h3>
<p><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/QQ%E5%9B%BE%E7%89%8720221015171443.jpg" srcset="/img/loading.gif" lazyload alt="QQ图片20221015171443" /></p>
<h3 id="操作数指示符"><a class="markdownIt-Anchor" href="#操作数指示符"></a> 操作数指示符</h3>
<p><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/as123gsz.jpg" srcset="/img/loading.gif" lazyload alt="as123gsz" /></p>
<h3 id="常用汇编"><a class="markdownIt-Anchor" href="#常用汇编"></a> 常用汇编</h3>
<ul>
<li>mov S,D : 把S的值传给D,具体的S见 操作数指示符</li>
<li>lea A,B : 计算A表达式的值传给B</li>
<li>cmp A,B : 对 B-A 的值进行判断, gl(有符号) ab(无符号)</li>
<li>test A,B : A&amp;B</li>
<li>je : 等于0跳转</li>
<li>jne : 不等于0跳转</li>
</ul>
<h2 id="gdb"><a class="markdownIt-Anchor" href="#gdb"></a> GDB</h2>
<h3 id="调试使用到的指令"><a class="markdownIt-Anchor" href="#调试使用到的指令"></a> 调试使用到的指令</h3>
<blockquote>
<p>注 : 括号表示完成指令名中可以被省略的部分</p>
</blockquote>
<table>
<thead>
<tr>
<th style="text-align:center">命令</th>
<th style="text-align:center">用途</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">gdb bomb</td>
<td style="text-align:center">使用gdb调试可执行文件bomb</td>
</tr>
<tr>
<td style="text-align:center">disas(semble) phase_1</td>
<td style="text-align:center">反汇编函数phase_1</td>
</tr>
<tr>
<td style="text-align:center">disas 0x402400</td>
<td style="text-align:center">反汇编地址0x402400附近的函数</td>
</tr>
<tr>
<td style="text-align:center">x/s 0x400544</td>
<td style="text-align:center">以字符串的形式输出,字符串在内存中的首地址为0x400544</td>
</tr>
<tr>
<td style="text-align:center">x/d 0x400544</td>
<td style="text-align:center">以整数的形式输出,整数在内存中的首地址为0x400544</td>
</tr>
<tr>
<td style="text-align:center">x/x 0x400544</td>
<td style="text-align:center">以16进制的形式输出</td>
</tr>
<tr>
<td style="text-align:center">x/a 0x400544</td>
<td style="text-align:center">以指针的形式</td>
</tr>
<tr>
<td style="text-align:center">b(reak) *0x400da4</td>
<td style="text-align:center">在0x400da4地址处打断点</td>
</tr>
<tr>
<td style="text-align:center">b phase_5</td>
<td style="text-align:center">在phase_5函数入口地址打断点</td>
</tr>
<tr>
<td style="text-align:center">b 74</td>
<td style="text-align:center">在源代码74行打断点</td>
</tr>
<tr>
<td style="text-align:center">r(un)</td>
<td style="text-align:center">运行可执行文件</td>
</tr>
<tr>
<td style="text-align:center">r input.txt</td>
<td style="text-align:center">运行可执行文件,传入一个参数,参数名是input.txt</td>
</tr>
<tr>
<td style="text-align:center">c(ontinue)</td>
<td style="text-align:center">从断点处继续运行</td>
</tr>
<tr>
<td style="text-align:center">k(ill)</td>
<td style="text-align:center">停止调试当前运行的程序</td>
</tr>
<tr>
<td style="text-align:center">q(uit)</td>
<td style="text-align:center">退出调试</td>
</tr>
<tr>
<td style="text-align:center">i(nfo) r(egister)</td>
<td style="text-align:center">打印所有整数寄存器及其内容</td>
</tr>
<tr>
<td style="text-align:center">i r rax</td>
<td style="text-align:center">打印rax寄存器及其内容</td>
</tr>
<tr>
<td style="text-align:center">i b</td>
<td style="text-align:center">打印所有断点</td>
</tr>
<tr>
<td style="text-align:center">d(elete) 1</td>
<td style="text-align:center">删除断点1</td>
</tr>
</tbody>
</table>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://linuxtools-rst.readthedocs.io/zh_CN/latest/tool/gdb.html">gdb 调试利器</a></p>
<p><a target="_blank" rel="noopener" href="https://darkdust.net/files/GDB%20Cheat%20Sheet.pdf">gdb文档</a></p>
</blockquote>
<h2 id="开始之前"><a class="markdownIt-Anchor" href="#开始之前"></a> 开始之前</h2>
<p>解压文件之后可以看到三个文件 <code>bomb</code> 是本次实验使用的可执行文件, <code>bomb.c</code> 是源代码中的主函数部分, <code>README</code>是介绍文件</p>
<p>浏览 <code>bomb.c</code> 可以看到它在开头引用了</p>
<div class="code-wrapper"><pre><code class="hljs c">...
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;support.h&quot;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;phases.h&quot;</span></span>
...</code></pre></div>
<p>所以可以看出 <code>bomb.c</code> 只是源文件的一部分, <code>bomb</code> 是由多个文件一起编译得到的,提供 bomb.c 文件实际上是为了给读者一个清晰的bomb lab思路</p>
<p>使用 <code>gdb bomb</code> 进入调试</p>
<h2 id="实验报告"><a class="markdownIt-Anchor" href="#实验报告"></a> 实验报告</h2>
<h3 id="phase_1"><a class="markdownIt-Anchor" href="#phase_1"></a> phase_1</h3>
<p>使用 <code>disas phase_1</code> 查看第一关汇编</p>
<div class="code-wrapper"><pre><code class="hljs txt">0x0000000000400ee0 &lt;+0&gt;:     sub    $0x8,%rsp
0x0000000000400ee4 &lt;+4&gt;:     mov    $0x402400,%esi               # esi = 0x402400
0x0000000000400ee9 &lt;+9&gt;:     call   0x401338 &lt;strings_not_equal&gt; # 比较 edi esi 两个字符串是否相同
0x0000000000400eee &lt;+14&gt;:    test   %eax,%eax                    # 相同返回0,不相同返回1
0x0000000000400ef0 &lt;+16&gt;:    je     0x400ef7 &lt;phase_1+23&gt;        # 应该相同
0x0000000000400ef2 &lt;+18&gt;:    call   0x40143a &lt;explode_bomb&gt;
0x0000000000400ef7 &lt;+23&gt;:    add    $0x8,%rsp
0x0000000000400efb &lt;+27&gt;:    ret</code></pre></div>
<p>前一步使用 <code>read_line</code> 读取了一行输入,输入被读入了</p>
<p>edi指向用户输入的字符串的首地址, <code>strings_not_equal</code> 函数的作用是判断两个字符串是否不相同,不相同返回1,相同返回0</p>
<blockquote>
<p>如果有耐心阅读可以稍微解释一下strings_not_equal的汇编细节,也可以省略</p>
</blockquote>
<p>0x402400指向的字符串通过 <code>x/s 0x402400</code> 查看是 <code>&quot;Border relations with Canada have never been better.&quot;</code></p>
<p>所以第一关的答案是</p>
<div class="code-wrapper"><pre><code class="hljs txt">Border relations with Canada have never been better.</code></pre></div>
<h3 id="phase_2"><a class="markdownIt-Anchor" href="#phase_2"></a> phase_2</h3>
<p><code>disas phase_2</code> ,先看第一部分</p>
<div class="code-wrapper"><pre><code class="hljs txt">0x0000000000400efc &lt;+0&gt;:     push   %rbp
0x0000000000400efd &lt;+1&gt;:     push   %rbx
0x0000000000400efe &lt;+2&gt;:     sub    $0x28,%rsp
0x0000000000400f02 &lt;+6&gt;:     mov    %rsp,%rsi                    #rsi = rsp
0x0000000000400f05 &lt;+9&gt;:     call   0x40145c &lt;read_six_numbers&gt;</code></pre></div>
<p>查看 <code>read_six_numbers</code> 函数反汇编</p>
<div class="code-wrapper"><pre><code class="hljs txt">0x000000000040145c &lt;+0&gt;:     sub    $0x18,%rsp
0x0000000000401460 &lt;+4&gt;:     mov    %rsi,%rdx                        # rdx = rsp
0x0000000000401463 &lt;+7&gt;:     lea    0x4(%rsi),%rcx                   # rcx = rsp + 4
0x0000000000401467 &lt;+11&gt;:    lea    0x14(%rsi),%rax                  # rax = rsp + 20
0x000000000040146b &lt;+15&gt;:    mov    %rax,0x8(%rsp)                   # (rsp+8) = rsp + 20
0x0000000000401470 &lt;+20&gt;:    lea    0x10(%rsi),%rax                  # rax = rsp + 16
0x0000000000401474 &lt;+24&gt;:    mov    %rax,(%rsp)                      # (rsp) = rsp + 16
0x0000000000401478 &lt;+28&gt;:    lea    0xc(%rsi),%r9                    # r9 = rsi + 12
0x000000000040147c &lt;+32&gt;:    lea    0x8(%rsi),%r8                    # r8 = rsi + 8
0x0000000000401480 &lt;+36&gt;:    mov    $0x4025c3,%esi                   # esi = 0x4025c3
0x0000000000401485 &lt;+41&gt;:    mov    $0x0,%eax                        # eax = 0
0x000000000040148a &lt;+46&gt;:    call   0x400bf0 &lt;__isoc99_sscanf@plt&gt;   # 调用sccanf函数
0x000000000040148f &lt;+51&gt;:    cmp    $0x5,%eax                        # 返回值应该大于5,即至少读取六个
0x0000000000401492 &lt;+54&gt;:    jg     0x401499 &lt;read_six_numbers+61&gt;
0x0000000000401494 &lt;+56&gt;:    call   0x40143a &lt;explode_bomb&gt;
0x0000000000401499 &lt;+61&gt;:    add    $0x18,%rsp
0x000000000040149d &lt;+65&gt;:    ret</code></pre></div>
<p><code>sccanf</code> 的作用是从字符串中提取得到格式化的值</p>
<p>查看 <code>0x4025c3</code> 的字符串为 <code>&quot;%d %d %d %d %d %d&quot;</code>,即接收六个整数(int),所以输入应该为空格分隔的六个整数</p>
<ul>
<li>rdi = 用户输入字符串的首地址</li>
<li>rsi = 0x4025c3(读取的格式,六个整数)</li>
<li>rdx = rsp</li>
<li>rcx = rsp+4</li>
<li>r8 = rsp+8</li>
<li>r9 = rsp+12</li>
<li>(rsp) = rsp+16</li>
<li>(rsp+8) = rsp+20</li>
</ul>
<p>根据x86-64架构调用函数时参数传递使用的寄存器和栈地址的规则</p>
<div class="code-wrapper"><pre><code class="hljs txt">// 假设输入是 1 2 3 4 5 6 -&gt; 字符串
int sccanf(&quot;1 2 3 4 5 6&quot;,&quot;%d %d %d %d %d %d&quot;,rdx,rsi,r8,r9,(rsp),(rsp+8)) -&gt; rax</code></pre></div>
<p>所以通过 <code>sscanf</code> 从字符串中读取的六个整数分别存放在(rsp),(rsp+4),…等连续六个位置</p>
<p>再看第二部分,</p>
<div class="code-wrapper"><pre><code class="hljs txt">0x0000000000400f0a &lt;+14&gt;:    cmpl   $0x1,(%rsp)             # 第一个输入的整数(number[0])应该为 1
0x0000000000400f0e &lt;+18&gt;:    je     0x400f30 &lt;phase_2+52&gt;
0x0000000000400f10 &lt;+20&gt;:    call   0x40143a &lt;explode_bomb&gt;
0x0000000000400f15 &lt;+25&gt;:    jmp    0x400f30 &lt;phase_2+52&gt;
0x0000000000400f17 &lt;+27&gt;:    mov    -0x4(%rbx),%eax         # eax = (rbx-4)=(rsp)=number[0]
0x0000000000400f1a &lt;+30&gt;:    add    %eax,%eax               # eax = 2*number[0]
0x0000000000400f1c &lt;+32&gt;:    cmp    %eax,(%rbx)             # (rbx) = eax, 即 (rsp+4)=number[1]=eax=2*number[0]
0x0000000000400f1e &lt;+34&gt;:    je     0x400f25 &lt;phase_2+41&gt;
0x0000000000400f20 &lt;+36&gt;:    call   0x40143a &lt;explode_bomb&gt;
0x0000000000400f25 &lt;+41&gt;:    add    $0x4,%rbx               # rbx += 4,开始循环
0x0000000000400f29 &lt;+45&gt;:    cmp    %rbp,%rbx               # 判断是否越界,越界则结束
0x0000000000400f2c &lt;+48&gt;:    jne    0x400f17 &lt;phase_2+27&gt;
0x0000000000400f2e &lt;+50&gt;:    jmp    0x400f3c &lt;phase_2+64&gt;
0x0000000000400f30 &lt;+52&gt;:    lea    0x4(%rsp),%rbx          # rbx = rsp+4 (number[1])
0x0000000000400f35 &lt;+57&gt;:    lea    0x18(%rsp),%rbp         # rbp = rsp+0x18 (0x18=24,相当于数组的边界number[6])
0x0000000000400f3a &lt;+62&gt;:    jmp    0x400f17 &lt;phase_2+27&gt;
0x0000000000400f3c &lt;+64&gt;:    add    $0x28,%rsp
0x0000000000400f40 &lt;+68&gt;:    pop    %rbx
0x0000000000400f41 &lt;+69&gt;:    pop    %rbp
0x0000000000400f42 &lt;+70&gt;:    ret</code></pre></div>
<p>阅读汇编,可知第一个输入的(rsp),也就是number[0]应该为1,之后的数字应该依次乘2,也就是一个首项为1,公比为2的等比数列,一共六个输入,所以答案为</p>
<div class="code-wrapper"><pre><code class="hljs txt">1 2 4 8 16 32</code></pre></div>
<h3 id="phase_3"><a class="markdownIt-Anchor" href="#phase_3"></a> phase_3</h3>
<div class="code-wrapper"><pre><code class="hljs txt">0x0000000000400f43 &lt;+0&gt;:     sub    $0x18,%rsp
0x0000000000400f47 &lt;+4&gt;:     lea    0xc(%rsp),%rcx
0x0000000000400f4c &lt;+9&gt;:     lea    0x8(%rsp),%rdx
0x0000000000400f51 &lt;+14&gt;:    mov    $0x4025cf,%esi
0x0000000000400f56 &lt;+19&gt;:    mov    $0x0,%eax
0x0000000000400f5b &lt;+24&gt;:    call   0x400bf0 &lt;__isoc99_sscanf@plt&gt;</code></pre></div>
<p>查看 <code>x/s 0x4025cf</code> 得到 “%d %d”,所以输入应该为空格分隔的两个整数</p>
<p>第一个值保存在rdx,也就是(rsp+8),第二个值保存在(rsp+12)</p>
<div class="code-wrapper"><pre><code class="hljs txt">0x0000000000400f60 &lt;+29&gt;:    cmp    $0x1,%eax               # 获取的值应该大于1
0x0000000000400f63 &lt;+32&gt;:    jg     0x400f6a &lt;phase_3+39&gt;
0x0000000000400f65 &lt;+34&gt;:    call   0x40143a &lt;explode_bomb&gt;
0x0000000000400f6a &lt;+39&gt;:    cmpl   $0x7,0x8(%rsp)          # 第一个值应该小于等于7
0x0000000000400f6f &lt;+44&gt;:    ja     0x400fad &lt;phase_3+106&gt;
0x0000000000400f71 &lt;+46&gt;:    mov    0x8(%rsp),%eax          # eax = number[0]
0x0000000000400f75 &lt;+50&gt;:    jmp    *0x402470(,%rax,8)      # 跳转到0x402470+8*number[0]的位置
0x0000000000400f7c &lt;+57&gt;:    mov    $0xcf,%eax
0x0000000000400f81 &lt;+62&gt;:    jmp    0x400fbe &lt;phase_3+123&gt;
0x0000000000400f83 &lt;+64&gt;:    mov    $0x2c3,%eax
0x0000000000400f88 &lt;+69&gt;:    jmp    0x400fbe &lt;phase_3+123&gt;
0x0000000000400f8a &lt;+71&gt;:    mov    $0x100,%eax
0x0000000000400f8f &lt;+76&gt;:    jmp    0x400fbe &lt;phase_3+123&gt;
0x0000000000400f91 &lt;+78&gt;:    mov    $0x185,%eax
0x0000000000400f96 &lt;+83&gt;:    jmp    0x400fbe &lt;phase_3+123&gt;
0x0000000000400f98 &lt;+85&gt;:    mov    $0xce,%eax
0x0000000000400f9d &lt;+90&gt;:    jmp    0x400fbe &lt;phase_3+123&gt;
0x0000000000400f9f &lt;+92&gt;:    mov    $0x2aa,%eax
0x0000000000400fa4 &lt;+97&gt;:    jmp    0x400fbe &lt;phase_3+123&gt;
0x0000000000400fa6 &lt;+99&gt;:    mov    $0x147,%eax
0x0000000000400fab &lt;+104&gt;:   jmp    0x400fbe &lt;phase_3+123&gt;
0x0000000000400fad &lt;+106&gt;:   call   0x40143a &lt;explode_bomb&gt;
0x0000000000400fb2 &lt;+111&gt;:   mov    $0x0,%eax
0x0000000000400fb7 &lt;+116&gt;:   jmp    0x400fbe &lt;phase_3+123&gt;
0x0000000000400fb9 &lt;+118&gt;:   mov    $0x137,%eax
0x0000000000400fbe &lt;+123&gt;:   cmp    0xc(%rsp),%eax          #number[1]应该等于eax
0x0000000000400fc2 &lt;+127&gt;:   je     0x400fc9 &lt;phase_3+134&gt;
0x0000000000400fc4 &lt;+129&gt;:   call   0x40143a &lt;explode_bomb&gt;
0x0000000000400fc9 &lt;+134&gt;:   add    $0x18,%rsp
0x0000000000400fcd &lt;+138&gt;:   ret</code></pre></div>
<p>这里 <code>&lt;+50&gt;:jmp *0x402470(,%rax,8)</code> 显然是一个跳转的地址,既然已经知道number[0]的值小于等于7,这里显然应该&gt;=0,所以我们可以使用 <code>x/a + 地址</code> 依次查看从 <code>0x402470</code> 的跳转位置,得到的结果如下</p>
<div class="code-wrapper"><pre><code class="hljs txt">(gdb) x/a 0x402470                      # 对应number[0] = 0
0x402470:       0x400f7c &lt;phase_3+57&gt;
(gdb) x/a 0x402478                      # 对应number[0] = 1
0x402478:       0x400fb9 &lt;phase_3+118&gt;
(gdb) x/a 0x402480                      # 对应number[0] = 2
0x402480:       0x400f83 &lt;phase_3+64&gt;
(gdb) x/a 0x402488                      # 对应number[0] = 3
0x402488:       0x400f8a &lt;phase_3+71&gt;
(gdb) x/a 0x402490                      # 对应number[0] = 4
0x402490:       0x400f91 &lt;phase_3+78&gt;
(gdb) x/a 0x402498                      # 对应number[0] = 5
0x402498:       0x400f98 &lt;phase_3+85&gt;
(gdb) x/a 0x4024a0                      # 对应number[0] = 6
0x4024a0:       0x400f9f &lt;phase_3+92&gt;
(gdb) x/a 0x4024a8                      # 对应number[0] = 7
0x4024a8:       0x400fa6 &lt;phase_3+99&gt;</code></pre></div>
<p>那么根据第一个输入可以得到不同的跳转地址,接下来只需要根据跳转的位置后面跟的 mov指令就可以得到number[1]的值了</p>
<p>所以第三关的答案不唯一,以下任何一组答案都可以通过</p>
<div class="code-wrapper"><pre><code class="hljs txt">0 207
1 331
2 707
3 256
4 389
5 206
6 682
7 327</code></pre></div>
<h3 id="phase_4"><a class="markdownIt-Anchor" href="#phase_4"></a> phase_4</h3>
<div class="code-wrapper"><pre><code class="hljs txt">0x000000000040100c &lt;+0&gt;:     sub    $0x18,%rsp
0x0000000000401010 &lt;+4&gt;:     lea    0xc(%rsp),%rcx                 # number[1]
0x0000000000401015 &lt;+9&gt;:     lea    0x8(%rsp),%rdx                 # number[0]
0x000000000040101a &lt;+14&gt;:    mov    $0x4025cf,%esi                 # %d %d
0x000000000040101f &lt;+19&gt;:    mov    $0x0,%eax
0x0000000000401024 &lt;+24&gt;:    call   0x400bf0 &lt;__isoc99_sscanf@plt&gt;
0x0000000000401029 &lt;+29&gt;:    cmp    $0x2,%eax
0x000000000040102c &lt;+32&gt;:    jne    0x401035 &lt;phase_4+41&gt;
0x000000000040102e &lt;+34&gt;:    cmpl   $0xe,0x8(%rsp)                 # number[0]&lt;=14
0x0000000000401033 &lt;+39&gt;:    jbe    0x40103a &lt;phase_4+46&gt;
0x0000000000401035 &lt;+41&gt;:    call   0x40143a &lt;explode_bomb&gt;
0x000000000040103a &lt;+46&gt;:    mov    $0xe,%edx                      # edx = 14
0x000000000040103f &lt;+51&gt;:    mov    $0x0,%esi                      # esi = 0
0x0000000000401044 &lt;+56&gt;:    mov    0x8(%rsp),%edi                 # edi = number[0]
0x0000000000401048 &lt;+60&gt;:    call   0x400fce &lt;func4&gt;               # 进入func4
0x000000000040104d &lt;+65&gt;:    test   %eax,%eax                      # 返回值应为0
0x000000000040104f &lt;+67&gt;:    jne    0x401058 &lt;phase_4+76&gt;
0x0000000000401051 &lt;+69&gt;:    cmpl   $0x0,0xc(%rsp)                 # number[1]=0
0x0000000000401056 &lt;+74&gt;:    je     0x40105d &lt;phase_4+81&gt;
0x0000000000401058 &lt;+76&gt;:    call   0x40143a &lt;explode_bomb&gt;
0x000000000040105d &lt;+81&gt;:    add    $0x18,%rsp
0x0000000000401061 &lt;+85&gt;:    ret</code></pre></div>
<p>phase_4的主体就是 <code>func4</code> 这个函数</p>
<p>这里不难看出是一个递归函数,三个参数,返回值为int,不妨设</p>
<div class="code-wrapper"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">func4</span><span class="hljs-params">(<span class="hljs-type">int</span> x, <span class="hljs-type">int</span> y, <span class="hljs-type">int</span> z)</span> &#123;
  ...     <span class="hljs-comment">// edi   esi   edx</span>
&#125;</code></pre></div>
<div class="code-wrapper"><pre><code class="hljs txt">0x0000000000400fce &lt;+0&gt;:     sub    $0x8,%rsp
0x0000000000400fd2 &lt;+4&gt;:     mov    %edx,%eax            # eax = z
0x0000000000400fd4 &lt;+6&gt;:     sub    %esi,%eax            # eax = z-y = 14
0x0000000000400fd6 &lt;+8&gt;:     mov    %eax,%ecx            # ecx = 14
0x0000000000400fd8 &lt;+10&gt;:    shr    $0x1f,%ecx           # ecx &gt;&gt;= 31
                                                         # ecx = 0 if ecx &gt;=0 else 1
0x0000000000400fdb &lt;+13&gt;:    add    %ecx,%eax            # eax += ecx
0x0000000000400fdd &lt;+15&gt;:    sar    %eax                 # eax &gt;&gt; 1 (y-z)/2
0x0000000000400fdf &lt;+17&gt;:    lea    (%rax,%rsi,1),%ecx   # [temp] = ecx = rax+rsi = (y-z)/2+z = (y+z)/2
0x0000000000400fe2 &lt;+20&gt;:    cmp    %edi,%ecx
0x0000000000400fe4 &lt;+22&gt;:    jle    0x400ff2 &lt;func4+36&gt;  # if (temp-x&lt;=0)
0x0000000000400fe6 &lt;+24&gt;:    lea    -0x1(%rcx),%edx      # z = temp-1
0x0000000000400fe9 &lt;+27&gt;:    call   0x400fce &lt;func4&gt;     # 递归调用
0x0000000000400fee &lt;+32&gt;:    add    %eax,%eax            # return 2*func4(x,y,temp-1)
0x0000000000400ff0 &lt;+34&gt;:    jmp    0x401007 &lt;func4+57&gt;
0x0000000000400ff2 &lt;+36&gt;:    mov    $0x0,%eax            # eax = 0 (递归出口)
0x0000000000400ff7 &lt;+41&gt;:    cmp    %edi,%ecx
0x0000000000400ff9 &lt;+43&gt;:    jge    0x401007 &lt;func4+57&gt;  # if (temp&gt;=x) -&gt; 这里其实等价于 temp == x
0x0000000000400ffb &lt;+45&gt;:    lea    0x1(%rcx),%esi       # esi = temp+1
0x0000000000400ffe &lt;+48&gt;:    call   0x400fce &lt;func4&gt;     # 递归调用
0x0000000000401003 &lt;+53&gt;:    lea    0x1(%rax,%rax,1),%eax# return 2*func4(x,temp+1,z)+1
0x0000000000401007 &lt;+57&gt;:    add    $0x8,%rsp
0x000000000040100b &lt;+61&gt;:    ret</code></pre></div>
<p>所以等价的C语言代码为</p>
<div class="code-wrapper"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">func4</span><span class="hljs-params">(<span class="hljs-type">int</span> x, <span class="hljs-type">int</span> y, <span class="hljs-type">int</span> z)</span> &#123;
  <span class="hljs-type">int</span> temp = 
&#125;</code></pre></div>
<h3 id="ascii"><a class="markdownIt-Anchor" href="#ascii"></a> ASCII</h3>
<ul>
<li>
<p><a target="_blank" rel="noopener" href="http://c.biancheng.net/c/ascii/">ASCII码对照表</a></p>
</li>
<li>
<p>在 WSL 中输入 <code>man ascii</code> 打开相关信息查看</p>
<blockquote>
<p><code>q</code> 退出预览</p>
</blockquote>
</li>
</ul>
<h3 id="1-plt是什么意思"><a class="markdownIt-Anchor" href="#1-plt是什么意思"></a> 1. @plt是什么意思 ?</h3>
<ul>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/25667205/what-exactly-does-putsplt-mean">回答1</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/5469274/what-does-plt-mean-here">回答2</a></li>
</ul>
<h3 id="2-为什么调用的函数开头会-sub-rsp"><a class="markdownIt-Anchor" href="#2-为什么调用的函数开头会-sub-rsp"></a> 2. 为什么调用的函数开头会 sub %rsp?</h3>
<p>分配栈帧</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/wade-luffy/p/6058067.html">运行时栈帧结构</a></p>
</blockquote>
<h3 id="3-sar-eax-少一个参数"><a class="markdownIt-Anchor" href="#3-sar-eax-少一个参数"></a> 3. sar %eax 少一个参数?</h3>
<p>默认移位1,等价于 sar $1,%eax</p>
<h3 id="4-fs0x28-是什么意思是做什么的"><a class="markdownIt-Anchor" href="#4-fs0x28-是什么意思是做什么的"></a> 4. %fs:0x28 是什么意思,是做什么的?</h3>
<p>虽然与本题关系不大,但是是一个非常好的问题,也是很深入的问题.</p>
<p>用途是确保 <code>0x18(%rsp)</code> 的数值在函数前后没有发生改动,如果发生改动则执行 <code>&lt;__stack_chk_fail@plt&gt;</code> 调用系统函数 __stack_chk_fail 跳出，从而防止栈溢出</p>
<p>简单来说就是,防止输入的字符串过长导致栈溢出</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/10325713/why-does-this-memory-address-fs0x28-fs0x28-have-a-random-value">Why does this memory address %fs:0x28 ( fs[0x28] ) have a random value?</a></p>
<p><a target="_blank" rel="noopener" href="https://unix.stackexchange.com/questions/453749/what-sets-fs0x28-stack-canary">What sets fs:[0x28] (stack canary)?</a></p>
</blockquote>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/CSAPP/">CSAPP</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/11/04/CSAPP/03-AttackLab/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">03-AttackLab</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/10/23/VPN%E4%B8%8E%E4%BB%A3%E7%90%86/WSL2%E4%BB%A3%E7%90%86%E9%85%8D%E7%BD%AE/">
                        <span class="hidden-mobile">WSL2代理配置</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments" lazyload>
                
                  
                
                
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://cdn.jsdelivr.net/npm/valine@1/dist/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"fEy8W8VvIoc26nT53dV2157j-gzGzoHsz","appKey":"s9HXuqmvBWrOaAiLA07Jg59A","path":"window.location.pathname","placeholder":"欢迎讨论,留下163邮箱我才能看到回复哦~","avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":true,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":true},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          Fluid.plugins.initFancyBox('#valine .vcontent img:not(.vemoji)');
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  




  <script defer src="/js/leancloud.js" ></script>







  

  
    <!-- KaTeX -->
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0/dist/katex.min.css" />
  








  

  

  

  

  

  





<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
